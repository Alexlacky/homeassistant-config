popup_harmony:
  triggers_update: "all"
  tap_action:
    action: "fire-dom-event"
    browser_mod:
      command: "popup"
      large: false
      hide_header: true
      card:

        type: custom:layout-card
        layout_type: vertical
        cards:


          ############################################################################
          #                                                                          #
          #   Header                                                                 #
          #                                                                          #
          ############################################################################

          - type: "custom:button-card"
            template: 
              - "popup_header"
              - "popup_header_harmony_label"
              - "popup_button_blue"
            # variables:
            #   ulm_card_switcher_time_left: '[[[ return variables.ulm_card_switcher_time_left ]]]'
            #   ulm_card_switcher_electric_current: '[[[ return variables.ulm_card_switcher_electric_current ]]]'
            #   ulm_card_switcher_auto_off: '[[[ return variables.ulm_card_switcher_auto_off ]]]'
            triggers_update: 'all'
            entity: '[[[ return variables.ulm_card_harmony_entity ]]]'
            icon: 'mdi:television'



          ############################################################################
          #                                                                          #
          #   Buttons                                                                #
          #                                                                          #
          ############################################################################

          - type: custom:layout-card
            layout_type: grid
            layout_options:
              grid-template-columns: 1fr 1fr
              grid-template-rows: auto
              grid-gap: 0px 4px
            cards:

              # - type: 'custom:button-card'
              #   triggers_update: 'all'
              #   template: 
              #     - 'popup_button'
              #     - 'ulm_language_variables'
              #     - 'popup_button_icon_harmony_power'
              #   variables:
              #     ulm_card_harmony_entity: '[[[ return variables.ulm_card_harmony_entity ]]]'
              #   name: 'Power'
              #   tap_action:
              #     action: 'call-service'
              #     service: 'remote.turn_on'
              #     service_data:
              #       entity_id: '[[[ return variables.ulm_card_harmony_entity ]]]'
              #       activity: 'PowerOff'

              - type: 'custom:button-card'
                triggers_update: 'all'
                template: 
                  - 'popup_button'
                  - 'ulm_language_variables'
                  - 'popup_button_harmony_activity_state'
                variables:
                  ulm_card_harmony_entity: '[[[ return variables.ulm_card_harmony_entity ]]]'
                  ulm_card_harmony_activity_name: '[[[ return variables.ulm_card_harmony_activity_1_name ]]]'
                name: '[[[ return variables.ulm_card_harmony_activity_1_name ]]]'
                tap_action:
                  action: 'call-service'
                  service: 'remote.turn_on'
                  service_data:
                    entity_id: '[[[ return variables.ulm_card_harmony_entity ]]]'
                    activity: '[[[ return variables.ulm_card_harmony_activity_1_name ]]]'
                icon: '[[[ return variables.ulm_card_harmony_activity_1_icon ]]]'


              - type: 'custom:button-card'
                triggers_update: 'all'
                template: 
                  - 'popup_button'
                  - 'ulm_language_variables'
                  - 'popup_button_harmony_activity_state'
                variables:
                  ulm_card_harmony_entity: '[[[ return variables.ulm_card_harmony_entity ]]]'
                  ulm_card_harmony_activity_name: '[[[ return variables.ulm_card_harmony_activity_2_name ]]]'
                name: '[[[ return variables.ulm_card_harmony_activity_2_name ]]]'
                tap_action:
                  action: 'call-service'
                  service: 'remote.turn_on'
                  service_data:
                    entity_id: '[[[ return variables.ulm_card_harmony_entity ]]]'
                    activity: '[[[ return variables.ulm_card_harmony_activity_2_name ]]]'
                icon: '[[[ return variables.ulm_card_harmony_activity_2_icon ]]]'


          - type: "custom:button-card"
            template: spacer
            variables:
              height: 40px



          ############################################################################
          #                                                                          #
          #   Footer                                                                 #
          #                                                                          #
          ############################################################################

          - type: custom:layout-card
            layout_type: grid
            layout_options:
              grid-template-columns: 1fr 1fr
              grid-template-rows: auto
              grid-gap: 0px 4px
            cards:

              - type: "custom:button-card"
                template: "popup_button_back"

              - type: "custom:button-card"
                template: 
                 - 'popup_button_power'
                #  - 'popup_button_icon_harmony_power'
                # variables:
                #   ulm_card_harmony_entity: '[[[ return variables.ulm_card_harmony_entity ]]]'
                name: '[[[ return variables.ulm_off ]]]'
                tap_action:
                  action: 'call-service'
                  service: 'remote.turn_on'
                  service_data:
                    entity_id: '[[[ return variables.ulm_card_harmony_entity ]]]'
                    activity: 'PowerOff'



popup_header_harmony_label:
  label: >
    [[[
      if (entity.attributes.current_activity == 'PowerOff')
        return variables.ulm_off;
      else 
        return entity.attributes.current_activity;
    ]]]


popup_button_icon_harmony_power:
  icon: >
    [[[
      if ( states[variables.ulm_card_harmony_entity].state == "on" )
        return "mdi:power-cycle";
      else 
        return "mdi:power-off";
    ]]]

popup_button_harmony_activity_state:
  state:
    - operator: 'template'
      value: '[[[ return states[variables.ulm_card_harmony_entity].attributes.current_activity == variables.ulm_card_harmony_activity_name; ]]]'
      styles:
        icon:
          - color: 'rgba(var(--color-green),1)'
        img_cell:
          - background-color: 'rgba(var(--color-green), 0.2)'    